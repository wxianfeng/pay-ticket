#!/usr/bin/env node

var mysql = require('mysql');
var fs = require('fs');
var dateFormat = require('dateformat');
var config = require('./config/config')

var code_path = config.code_path;

// mysql init
var dbContent = fs.readFileSync(__dirname + "/database.json", "utf8");
var databaseCfg = JSON.parse(dbContent);
var dev = databaseCfg.development;
var connection = mysql.createConnection({
  host     : dev.host,
  user     : dev.user,
  password : dev.password,
  database: dev.database
});

function insertDB(codes) {
  connection.connect();

  var date = new Date();
  var date = dateFormat(date, "yyyy-mm-dd h:MM:ss");

  for (var i = 0; i < codes.length; i++) {
    var code = codes[i];
    var sql = "insert into codes(code,created_at,updated_at) values(\"" + code + "\", \"" + date +"\", \""+ date +"\")";
    connection.query(sql, function(err, result){
      console.log(err);
      console.log(result);
    })
  }
  
  connection.end();
}

fs.readFile(code_path, 'utf8', function (err,data) {
  if (err) {
    return console.log(err);
  }
  var array = data.toString().split("\n");

  console.log(array);

  insertDB(array);
  return;
});
